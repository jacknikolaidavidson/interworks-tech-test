{{ config(materialized='table') }}

select 
    TRANSACTIONID,
    FLIGHTDATE,
    AIRLINECODE,
    TRIM(SPLIT_PART(AIRLINENAME, ':', 1)) AS AIRLINENAME,
    TAILNUM,
    FLIGHTNUM,
    ORIGINAIRPORTCODE,
    TRIM(SPLIT_PART(ORIGAIRPORTNAME, ':', 2)) AS ORIGAIRPORTNAME,
    ORIGINCITYNAME,
    ORIGINSTATE,
    ORIGINSTATENAME,
    DESTAIRPORTCODE,
    TRIM(SPLIT_PART(ORIGAIRPORTNAME, ':', 2)) AS DESTAIRPORTNAME,
    DESTCITYNAME,
    DESTSTATE,
    DESTSTATENAME,
    CRSDEPTIME,
    DEPTIME,
    DEPDELAY,
    TAXIOUT,
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(WHEELSOFF), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(WHEELSOFF), 4, '0')
    END,
    'HH24MI') AS WHEELSOFF, -- Convert 2400 to 0000
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(WHEELSON), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(WHEELSON), 4, '0')
    END,
    'HH24MI') AS WHEELSON, -- Convert 2400 to 0000
    TAXIIN,
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(CRSARRTIME), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(CRSARRTIME), 4, '0')
    END,
    'HH24MI') AS CRSARRTIME, -- Convert 2400 to 0000
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(ARRTIME), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(ARRTIME), 4, '0')
    END,
    'HH24MI') AS ARRTIME, -- Convert 2400 to 0000
    ARRDELAY,
    CRSELAPSEDTIME,
    ACTUALELAPSEDTIME,
    CASE 
        WHEN UPPER(CANCELLED) IN ('1', 'T', 'TRUE') THEN 1
        ELSE 0
    END AS CANCELLED,
    CASE 
        WHEN UPPER(DIVERTED) IN ('1', 'T', 'TRUE') THEN 1
        ELSE 0
    END AS DIVERTED,
    DISTANCE 
FROM {{ ref('STG_FLIGHTS')}}
