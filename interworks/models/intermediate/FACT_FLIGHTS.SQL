{{ config(materialized='table', cluster_by = ['FLIGHTDATE', 'AIRLINECODE']) }}

select 
    TRANSACTIONID AS "TRANSACTIONID",
    FLIGHTDATE AS "FLIGHTDATE",
    AIRLINECODE AS "AIRLINECODE",
    TAILNUM AS "TAILNUM",
    FLIGHTNUM AS "FLIGHTNUM",
    ORIGINAIRPORTCODE AS "ORIGINAIRPORTCODE",
    DESTAIRPORTCODE AS "DESTAIRPORTCODE",
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(CRSDEPTIME), 4, '0') = '2400' THEN '0000'
        WHEN CRSDEPTIME=0 then NULL 
        ELSE LPAD(TO_VARCHAR(CRSDEPTIME), 4, '0')
    END,
    'HH24MI') AS "CRSDEPTIME", -- Convert 2400 to 0000
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(DEPTIME), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(DEPTIME), 4, '0')
    END,
    'HH24MI') AS "DEPTIME", -- Convert 2400 to 0000
    DEPDELAY AS "DEPDELAY",
    TAXIOUT AS "TAXIOUT",
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(WHEELSOFF), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(WHEELSOFF), 4, '0')
    END,
    'HH24MI') AS "WHEELSOFF", -- Convert 2400 to 0000
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(WHEELSON), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(WHEELSON), 4, '0')
    END,
    'HH24MI') AS "WHEELSON", -- Convert 2400 to 0000
    TAXIIN AS "TAXIIN",
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(CRSARRTIME), 4, '0') = '2400' THEN '0000'
        WHEN CRSARRTIME=0 THEN NULL
        ELSE LPAD(TO_VARCHAR(CRSARRTIME), 4, '0')
    END,
    'HH24MI') AS CRSARRTIME, -- Convert 2400 to 0000
    TO_TIME(
    CASE 
        WHEN LPAD(TO_VARCHAR(ARRTIME), 4, '0') = '2400' THEN '0000'
        ELSE LPAD(TO_VARCHAR(ARRTIME), 4, '0')
    END,
    'HH24MI') AS ARRTIME, -- Convert 2400 to 0000
    ARRDELAY AS "ARRDELAY",
    CRSELAPSEDTIME AS "CRSELAPSEDTIME",
    CASE 
        WHEN UPPER(CANCELLED) IN ('1', 'T', 'TRUE') THEN 1
        ELSE 0
    END AS CANCELLED,
    CASE 
        WHEN UPPER(DIVERTED) IN ('1', 'T', 'TRUE') THEN 1
        ELSE 0
    END AS DIVERTED,
    DISTANCE AS "DISTANCE",
    CASE 
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 0 AND 100 THEN '0-100 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 101 AND 200 THEN '101-200 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 201 AND 300 THEN '201-300 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 301 AND 400 THEN '301-400 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 401 AND 500 THEN '401-500 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 501 AND 600 THEN '501-600 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 601 AND 700 THEN '601-700 miles'
        WHEN TO_NUMBER(REPLACE("DISTANCE", ' miles', '')) BETWEEN 701 AND 800 THEN '701-800 miles'
        ELSE '800+ miles'
    END AS "DISTANCEGROUP",
    CASE 
        WHEN DEPDELAY > 15 THEN 1
        ELSE 0
    END AS "DEPDELAYGT15",
    CASE 
        WHEN TO_NUMBER("ARRTIME") < TO_NUMBER("DEPTIME") THEN 1
        -- WHEN TO_NUMBER("ACTUALELAPSEDTIME") > 1440 THEN 1 -- No flights > 24 hours when querying but if so, uncomment this
        ELSE 0
    END AS "NEXTDAYARR"
    FROM {{ ref('STG_FLIGHTS') }}